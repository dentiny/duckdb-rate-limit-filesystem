# name: test/sql/rate_limit_fs_wrap.test
# description: Test rate_limit_fs_wrap() function
# group: [sql]

require rate_limit_filesystem

# Fake filesystem should be registered on extension load
query I
SELECT COUNT(*) > 0 FROM rate_limit_fs_list_filesystems() WHERE name = 'RateLimitFsFakeFileSystem';
----
true

# Wrap the fake filesystem with rate limiting
query I
SELECT rate_limit_fs_wrap('RateLimitFsFakeFileSystem');
----
true

# After wrapping, the original fake filesystem should be replaced with the rate-limited version
query I
SELECT COUNT(*) > 0 FROM rate_limit_fs_list_filesystems() WHERE name = 'RateLimitFileSystem - RateLimitFsFakeFileSystem';
----
true

# The original fake filesystem should no longer exist
query I
SELECT COUNT(*) FROM rate_limit_fs_list_filesystems() WHERE name = 'RateLimitFsFakeFileSystem';
----
0

# Set quota on the wrapped filesystem (using the inner filesystem's name)
statement ok
SELECT rate_limit_fs_quota('RateLimitFsFakeFileSystem', 'read', 1000000, 'blocking');

# Verify the config was set
query IIII
SELECT filesystem, operation, quota, mode FROM rate_limit_fs_configs() WHERE filesystem = 'RateLimitFsFakeFileSystem';
----
RateLimitFsFakeFileSystem	read	1000000	blocking

# Clear the config
statement ok
SELECT rate_limit_fs_clear('RateLimitFsFakeFileSystem', '*');

# Verify cleared
query I
SELECT COUNT(*) FROM rate_limit_fs_configs() WHERE filesystem = 'RateLimitFsFakeFileSystem';
----
0
