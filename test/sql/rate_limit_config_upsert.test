# name: test/sql/rate_limit_config_upsert.test
# description: test rate limit configuration UPSERT and clear operations
# group: [sql]

require rate_limit_filesystem

# =============================================================================
# Setup initial config
# =============================================================================

query I
SELECT rate_limit_fs_quota('RateLimitFsFakeFileSystem', 'read', 1000000, 'blocking');
----
true

query I
SELECT rate_limit_fs_burst('RateLimitFsFakeFileSystem', 'read', 5000000);
----
true

# =============================================================================
# UPSERT tests (UPDATE - modifying existing configs)
# =============================================================================

# Update quota value for existing operation
query I
SELECT rate_limit_fs_quota('RateLimitFsFakeFileSystem', 'read', 2000000, 'blocking');
----
true

# Verify quota was updated, burst unchanged
query IIIII
SELECT * FROM rate_limit_fs_configs() WHERE operation = 'read';
----
RateLimitFsFakeFileSystem	read	2000000	blocking	5000000

# Update mode for existing operation
query I
SELECT rate_limit_fs_quota('RateLimitFsFakeFileSystem', 'read', 2000000, 'non_blocking');
----
true

# Verify mode was updated
query IIIII
SELECT * FROM rate_limit_fs_configs() WHERE operation = 'read';
----
RateLimitFsFakeFileSystem	read	2000000	non_blocking	5000000

# Update burst value for existing operation
query I
SELECT rate_limit_fs_burst('RateLimitFsFakeFileSystem', 'read', 10000000);
----
true

# Verify burst was updated, quota and mode unchanged
query IIIII
SELECT * FROM rate_limit_fs_configs() WHERE operation = 'read';
----
RateLimitFsFakeFileSystem	read	2000000	non_blocking	10000000

# Verify only one config exists (UPSERT, not duplicate INSERT)
query I
SELECT COUNT(*) FROM rate_limit_fs_configs() WHERE operation = 'read';
----
1

# =============================================================================
# Clear operations
# =============================================================================

# Add more configs for clear tests
query I
SELECT rate_limit_fs_quota('RateLimitFsFakeFileSystem', 'write', 500000, 'blocking');
----
true

query I
SELECT rate_limit_fs_quota('RateLimitFsFakeFileSystem', 'list', 100, 'blocking');
----
true

# Verify multiple configs exist
query I
SELECT COUNT(*) FROM rate_limit_fs_configs();
----
3

# Test clearing a specific operation for a filesystem
query I
SELECT rate_limit_fs_clear('RateLimitFsFakeFileSystem', 'read');
----
true

query I
SELECT COUNT(*) FROM rate_limit_fs_configs() WHERE operation = 'read';
----
0

# Other configs still exist
query I
SELECT COUNT(*) FROM rate_limit_fs_configs();
----
2

# Test clearing all configs for a filesystem
query I
SELECT rate_limit_fs_clear('RateLimitFsFakeFileSystem', '*');
----
true

query I
SELECT COUNT(*) FROM rate_limit_fs_configs() WHERE filesystem = 'RateLimitFsFakeFileSystem';
----
0

# Test clearing all configs globally
query I
SELECT rate_limit_fs_clear('*', '*');
----
true

query I
SELECT COUNT(*) FROM rate_limit_fs_configs();
----
0
