# name: test/sql/rate_limit_config.test
# description: test rate limit filesystem configuration functions
# group: [sql]

# Require the extension
require rate_limit_filesystem

# =============================================================================
# Invalid setting tests (error cases)
# =============================================================================

# Test error: invalid mode
statement error
SELECT rate_limit_fs_quota('read', 1000, 'invalid_mode');
----
Invalid rate limit mode

# Test error: negative quota
statement error
SELECT rate_limit_fs_quota('read', -100, 'blocking');
----
Quota value must be non-negative

# Test error: negative burst
statement error
SELECT rate_limit_fs_burst('read', -100);
----
Burst value must be non-negative

# =============================================================================
# Valid configuration tests (SET - initial creation)
# =============================================================================

# Test setting a quota with blocking mode
query I
SELECT rate_limit_fs_quota('read', 1000000, 'blocking');
----
read

# Test setting a burst
query I
SELECT rate_limit_fs_burst('read', 5000000);
----
read

# Test viewing the config
query ITIT
SELECT * FROM rate_limit_fs_configs() WHERE operation = 'read';
----
read	1000000	blocking	5000000

# =============================================================================
# UPSERT tests (UPDATE - modifying existing configs)
# =============================================================================

# Update quota value for existing operation
query I
SELECT rate_limit_fs_quota('read', 2000000, 'blocking');
----
read

# Verify quota was updated, burst unchanged
query ITIT
SELECT * FROM rate_limit_fs_configs() WHERE operation = 'read';
----
read	2000000	blocking	5000000

# Update mode for existing operation
query I
SELECT rate_limit_fs_quota('read', 2000000, 'non_blocking');
----
read

# Verify mode was updated
query ITIT
SELECT * FROM rate_limit_fs_configs() WHERE operation = 'read';
----
read	2000000	non_blocking	5000000

# Update burst value for existing operation
query I
SELECT rate_limit_fs_burst('read', 10000000);
----
read

# Verify burst was updated, quota and mode unchanged
query ITIT
SELECT * FROM rate_limit_fs_configs() WHERE operation = 'read';
----
read	2000000	non_blocking	10000000

# Verify only one config exists (UPSERT, not duplicate INSERT)
query I
SELECT COUNT(*) FROM rate_limit_fs_configs() WHERE operation = 'read';
----
1

# =============================================================================
# Additional valid configuration tests
# =============================================================================

# Test setting quota with non-blocking mode
query I
SELECT rate_limit_fs_quota('write', 500000, 'non_blocking');
----
write

# Test setting quota with alternative mode name
query I
SELECT rate_limit_fs_quota('list', 100, 'non-blocking');
----
list

# Test viewing all configs
query ITIT
SELECT * FROM rate_limit_fs_configs() ORDER BY operation;
----
list	100	non_blocking	0
read	2000000	non_blocking	10000000
write	500000	non_blocking	0

# Test setting burst-only config
query I
SELECT rate_limit_fs_burst('delete', 1000);
----
delete

query ITIT
SELECT * FROM rate_limit_fs_configs() WHERE operation = 'delete';
----
delete	0	blocking	1000

# Test clearing a specific config
query I
SELECT rate_limit_fs_clear('delete');
----
delete

query I
SELECT COUNT(*) FROM rate_limit_fs_configs() WHERE operation = 'delete';
----
0

# Test clearing all configs
query I
SELECT rate_limit_fs_clear('*');
----
all

query I
SELECT COUNT(*) FROM rate_limit_fs_configs();
----
0
