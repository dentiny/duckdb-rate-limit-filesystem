# name: test/sql/rate_limit_config_basic.test
# description: test basic rate limit configuration operations
# group: [sql]

require rate_limit_filesystem

# =============================================================================
# Case-insensitive operation tests
# =============================================================================

# Test uppercase operation is normalized to lowercase
query I
SELECT rate_limit_fs_quota('RateLimitFsFakeFileSystem', 'READ', 1000, 'blocking');
----
true

# Verify it's stored as lowercase
query IIIII
SELECT * FROM rate_limit_fs_configs() WHERE operation = 'read';
----
RateLimitFsFakeFileSystem	read	1000	blocking	0

# Test mixed case operation
query I
SELECT rate_limit_fs_burst('RateLimitFsFakeFileSystem', 'ReAd', 2000);
----
true

# Verify burst was added to existing lowercase entry (UPSERT)
query IIIII
SELECT * FROM rate_limit_fs_configs() WHERE operation = 'read';
----
RateLimitFsFakeFileSystem	read	1000	blocking	2000

# Clear for next tests
query I
SELECT rate_limit_fs_clear('*', '*');
----
true

# =============================================================================
# Valid configuration tests
# =============================================================================

# Test setting a quota with blocking mode
query I
SELECT rate_limit_fs_quota('RateLimitFsFakeFileSystem', 'read', 1000000, 'blocking');
----
true

# Test setting a burst
query I
SELECT rate_limit_fs_burst('RateLimitFsFakeFileSystem', 'read', 5000000);
----
true

# Test viewing the config
query IIIII
SELECT * FROM rate_limit_fs_configs() WHERE operation = 'read';
----
RateLimitFsFakeFileSystem	read	1000000	blocking	5000000

# Test setting quota with non-blocking mode
query I
SELECT rate_limit_fs_quota('RateLimitFsFakeFileSystem', 'write', 500000, 'non_blocking');
----
true

# Test setting quota with alternative mode name (hyphenated)
query I
SELECT rate_limit_fs_quota('RateLimitFsFakeFileSystem', 'list', 100, 'non-blocking');
----
true

# Test viewing all configs
query IIIII
SELECT * FROM rate_limit_fs_configs() ORDER BY operation;
----
RateLimitFsFakeFileSystem	list	100	non_blocking	0
RateLimitFsFakeFileSystem	read	1000000	blocking	5000000
RateLimitFsFakeFileSystem	write	500000	non_blocking	0

# Cleanup
query I
SELECT rate_limit_fs_clear('*', '*');
----
true

